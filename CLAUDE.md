# CLAUDE.md

This file provides guidance to Claude Code (claude.ai/code) when working with code in this repository.

## Project Overview

ps-package is a CLI tool that automates building and packaging PowerSchool plugins. It handles version management using calendar versioning (CalVer), merges PowerSchool-specific folders, creates ZIP archives, and maintains a clean build directory.

## Development Commands

### Build the plugin
```bash
node index.js
# or
pnpm run build
```

### Run tests
```bash
pnpm test
# or
vitest
```

### Run tests in watch mode
```bash
vitest --watch
```

### Release (version, tag, push, publish)
```bash
pnpm run release
```

## Architecture

### Entry Point & Build Flow
- **index.js**: Entry point that calls `main()` from src/main.js
- **src/main.js**: Contains all build orchestration logic

### Build Process (main function)
1. **Version Management**: Reads current version from package.json, generates new version using CalVer format (YY.MM.PATCH)
2. **Directory Setup**: Ensures dist/, plugin_archive/, and schema/ directories exist
3. **Version Updates**: Updates version in package.json, plugin.xml, and all pagecataloging JSON files
4. **XML Generation**: Creates two plugin.xml variants:
   - Standard plugin.xml in dist/
   - "DATA" variant in schema/ (appends " DATA" to plugin name, removes access_request)
5. **Build Directory Preparation**: Merges PowerSchool folders, removes junk files, deletes template index.html
6. **Framework-Specific Handling**: If projectType is 'svelte', copies public/build to dist/WEB_ROOT/{pluginName}
7. **Archive Creation**: Creates two ZIP files in plugin_archive/:
   - {pluginName}-{version}.zip (from dist/)
   - DATA-{pluginName}-{version}.zip (from schema/)
8. **Archive Pruning**: Keeps only the 10 most recent archives

### Key Configuration (config object in src/main.js)
- **sourceDir**: src/ - Source files
- **powerSchoolSourceDir**: src/powerschool/ - PowerSchool-specific files
- **buildDir**: dist/ - Build output
- **schemaDir**: schema/ - Schema-only plugin files
- **archiveDir**: plugin_archive/ - ZIP archives
- **psFolders**: PowerSchool folders to merge - ['permissions_root', 'user_schema_root', 'queries_root', 'WEB_ROOT', 'pagecataloging', 'MessageKeys']
  - user_schema_root and MessageKeys go to schema/
  - All others go to dist/
- **junkFiles**: Files to remove - ['.DS_Store', 'Thumbs.db', 'robots.txt', 'sitemap.xml', 'ssr-manifest.json']
- **projectType**: 'vue' or 'svelte' - affects build steps

### Version Management
Uses custom CalVer implementation (YY.MM.PATCH format):
- If year or month changes, patch resets to 01
- Otherwise, patch increments
- Fallback: generates new version from current date if parsing fails
- See getNewVersion() in src/main.js:38

### Expected Project Structure
```
project-root/
├── src/
│   └── powerschool/          # PowerSchool-specific files
│       ├── permissions_root/
│       ├── user_schema_root/
│       ├── queries_root/
│       ├── WEB_ROOT/
│       ├── pagecataloging/
│       └── MessageKeys/
├── plugin.xml                # Plugin manifest (at root)
├── package.json
├── dist/                     # Generated by build
├── schema/                   # Generated by build
└── plugin_archive/           # Generated by build
```

### Testing
- Uses Vitest
- Tests are colocated with source files (*.test.js)
- Mocks: fs operations, xml2js, archiver, logger
- Key test files:
  - index.test.js: Verifies entry point calls main()
  - src/main.test.js: Comprehensive tests for all build functions

### Utilities
- **src/utils/logger.js**: Simple console logger with info/warn/error methods
- **slugify()**: Converts plugin names to filename-safe format (replaces spaces/hyphens with underscores)

## Important Notes

- The build process overwrites dist/ and plugin_archive/ directories
- Plugin names longer than 35 characters are truncated in the schema variant
- Archive pruning keeps only the 10 most recent files by modification time
- For Svelte projects, expects build output in public/build/
- All version strings use CalVer format: YY.MM.PATCH (e.g., 25.07.13)
